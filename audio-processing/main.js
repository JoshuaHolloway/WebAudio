console.clear();

// instigate our audio context

// for cross browser
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

// load some sound
const audioElement = document.querySelector('audio');
const track = audioCtx.createMediaElementSource(audioElement);

const playButton = document.querySelector('.tape-controls-play');

// play pause audio
playButton.addEventListener('click', function () {

    // check if context is in suspended state (autoplay policy)
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }

    if (this.dataset.playing === 'false') {
        audioElement.play();
        this.dataset.playing = 'true';
        // if track is playing pause it
    } else if (this.dataset.playing === 'true') {
        audioElement.pause();
        this.dataset.playing = 'false';
    }

    let state = this.getAttribute('aria-checked') === "true" ? true : false;
    this.setAttribute('aria-checked', state ? "false" : "true");

}, false);

// if track ends
audioElement.addEventListener('ended', () => {
    playButton.dataset.playing = 'false';
    playButton.setAttribute("aria-checked", "false");
}, false);

// volume
const gainNode = audioCtx.createGain();

const volumeControl = document.querySelector('[data-action="volume"]');
volumeControl.addEventListener('input', function () {
    gainNode.gain.value = this.value;
}, false);

// panning
const pannerOptions = { pan: 0 };
const panner = new StereoPannerNode(audioCtx, pannerOptions);

const pannerControl = document.querySelector('[data-action="panner"]');
pannerControl.addEventListener('input', function () {
    panner.pan.value = this.value;
}, false);

//======================================================
// main.mjs
//======================================================

// 100hz, 200hz
const weights_lpf = [9.361938e-05, 9.126226e-06, 9.596512e-06, 1.000845e-05, 1.049622e-05, 1.092783e-05, 1.143953e-05, 1.189874e-05, 1.244378e-05, 1.293860e-05, 1.352222e-05, 1.405069e-05, 1.466312e-05, 1.520470e-05, 1.582262e-05, 1.635741e-05, 1.699279e-05, 1.757059e-05, 1.833830e-05, 1.887763e-05, 1.955180e-05, 2.023703e-05, 2.092707e-05, 2.161669e-05, 2.234469e-05, 2.305072e-05, 2.380551e-05, 2.453233e-05, 2.531633e-05, 2.607144e-05, 2.688835e-05, 2.767003e-05, 2.850951e-05, 2.930539e-05, 3.016544e-05, 3.099205e-05, 3.189723e-05, 3.273384e-05, 3.362849e-05, 3.451975e-05, 3.543629e-05, 3.633867e-05, 3.728851e-05, 3.820956e-05, 3.918257e-05, 4.012255e-05, 4.111710e-05, 4.207852e-05, 4.309672e-05, 4.407934e-05, 4.511536e-05, 4.611177e-05, 4.716410e-05, 4.818364e-05, 4.926175e-05, 5.029406e-05, 5.137435e-05, 5.243555e-05, 5.353189e-05, 5.459845e-05, 5.571599e-05, 5.679321e-05, 5.792269e-05, 5.900984e-05, 6.014887e-05, 6.124635e-05, 6.239623e-05, 6.350342e-05, 6.465943e-05, 6.576992e-05, 6.692963e-05, 6.804793e-05, 6.921495e-05, 7.033360e-05, 7.149533e-05, 7.262101e-05, 7.378413e-05, 7.490189e-05, 7.606856e-05, 7.718256e-05, 7.834415e-05, 7.945254e-05, 8.060583e-05, 8.170670e-05, 8.285175e-05, 8.394346e-05, 8.507572e-05, 8.615229e-05, 8.726887e-05, 8.833200e-05, 8.943364e-05, 9.047683e-05, 9.155506e-05, 9.258019e-05, 9.363693e-05, 9.463250e-05, 9.566719e-05, 9.663588e-05, 9.764021e-05, 9.857916e-05, 9.954983e-05, 1.004557e-04, 1.013920e-04, 1.022625e-04, 1.031599e-04, 1.039891e-04, 1.048442e-04, 1.056316e-04, 1.064431e-04, 1.071829e-04, 1.079444e-04, 1.086362e-04, 1.093470e-04, 1.099817e-04, 1.106397e-04, 1.112188e-04, 1.118164e-04, 1.123360e-04, 1.128696e-04, 1.133251e-04, 1.137930e-04, 1.141813e-04, 1.145789e-04, 1.148943e-04, 1.152176e-04, 1.154584e-04, 1.157050e-04, 1.158655e-04, 1.160298e-04, 1.161083e-04, 1.161878e-04, 1.161764e-04, 1.161679e-04, 1.160670e-04, 1.159637e-04, 1.157689e-04, 1.155675e-04, 1.152737e-04, 1.149722e-04, 1.145765e-04, 1.141703e-04, 1.136674e-04, 1.131525e-04, 1.125401e-04, 1.119136e-04, 1.111865e-04, 1.104437e-04, 1.096002e-04, 1.087379e-04, 1.077712e-04, 1.067864e-04, 1.056964e-04, 1.045832e-04, 1.033655e-04, 1.021210e-04, 1.007706e-04, 9.939283e-05, 9.790699e-05, 9.639170e-05, 9.476614e-05, 9.310978e-05, 9.134228e-05, 8.954196e-05, 8.762833e-05, 8.568049e-05, 8.361894e-05, 8.152050e-05, 7.930569e-05, 7.705406e-05, 7.468593e-05, 7.227669e-05, 6.975152e-05, 6.718302e-05, 6.449680e-05, 6.176753e-05, 5.891881e-05, 5.602549e-05, 5.301131e-05, 4.995157e-05, 4.677052e-05, 4.354229e-05, 4.019167e-05, 3.679304e-05, 3.327210e-05, 2.970110e-05, 2.600640e-05, 2.226182e-05, 1.839407e-05, 1.447351e-05, 1.043040e-05, 6.333625e-06, 2.112852e-06, -2.160509e-06, -6.558772e-06, -1.101034e-05, -1.558703e-05, -2.021740e-05, -2.497242e-05, -2.978195e-05, -3.471611e-05, -3.970464e-05, -4.481699e-05, -4.998476e-05, -5.527654e-05, -6.062278e-05, -6.609177e-05, -7.161653e-05, -7.726276e-05, -8.296422e-05, -8.878761e-05, -9.466430e-05, -1.006624e-04, -1.067138e-04, -1.128851e-04, -1.191093e-04, -1.254519e-04, -1.318470e-04, -1.383591e-04, -1.449225e-04, -1.516009e-04, -1.583304e-04, -1.651736e-04, -1.720658e-04, -1.790695e-04, -1.861217e-04, -1.932833e-04, -2.004913e-04, -2.078078e-04, -2.151677e-04, -2.226340e-04, -2.301426e-04, -2.377545e-04, -2.454069e-04, -2.531597e-04, -2.609513e-04, -2.688404e-04, -2.767657e-04, -2.847853e-04, -2.928391e-04, -3.009845e-04, -3.091609e-04, -3.174252e-04, -3.257183e-04, -3.340957e-04, -3.424986e-04, -3.509831e-04, -3.594892e-04, -3.680728e-04, -3.766756e-04, -3.853513e-04, -3.940431e-04, -4.028035e-04, -4.115768e-04, -4.204144e-04, -4.292605e-04, -4.381666e-04, -4.470778e-04, -4.560446e-04, -4.650118e-04, -4.740298e-04, -4.830444e-04, -4.921048e-04, -5.011570e-04, -5.102508e-04, -5.193314e-04, -5.284478e-04, -5.375475e-04, -5.466767e-04, -5.557845e-04, -5.649166e-04, -5.740222e-04, -5.831467e-04, -5.922391e-04, -6.013444e-04, -6.104128e-04, -6.194886e-04, -6.285215e-04, -6.375555e-04, -6.465416e-04, -6.555224e-04, -6.644493e-04, -6.733652e-04, -6.822212e-04, -6.910592e-04, -6.998324e-04, -7.085804e-04, -7.172574e-04, -7.259031e-04, -7.344714e-04, -7.430019e-04, -7.514484e-04, -7.598502e-04, -7.681618e-04, -7.764221e-04, -7.845854e-04, -7.926902e-04, -8.006919e-04, -8.086278e-04, -8.164538e-04, -8.242071e-04, -8.318440e-04, -8.394003e-04, -8.468342e-04, -8.541798e-04, -8.613958e-04, -8.685168e-04, -8.755012e-04, -8.823832e-04, -8.891214e-04, -8.957498e-04, -9.022276e-04, -9.085883e-04, -9.147912e-04, -9.208693e-04, -9.267830e-04, -9.325642e-04, -9.381737e-04, -9.436435e-04, -9.489347e-04, -9.540782e-04, -9.590366e-04, -9.638396e-04, -9.684499e-04, -9.728981e-04, -9.771463e-04, -9.812251e-04, -9.850966e-04, -9.887911e-04, -9.922719e-04, -9.955680e-04, -9.986434e-04, -1.001527e-03, -1.004183e-03, -1.006639e-03, -1.008862e-03, -1.010877e-03, -1.012652e-03, -1.014213e-03, -1.015527e-03, -1.016619e-03, -1.017457e-03, -1.018068e-03, -1.018418e-03, -1.018533e-03, -1.018381e-03, -1.017988e-03, -1.017321e-03, -1.016407e-03, -1.015213e-03, -1.013764e-03, -1.012031e-03, -1.010036e-03, -1.007750e-03, -1.005197e-03, -1.002347e-03, -9.992233e-04, -9.957980e-04, -9.920933e-04, -9.880807e-04, -9.837836e-04, -9.791736e-04, -9.742731e-04, -9.690550e-04, -9.635408e-04, -9.577044e-04, -9.515668e-04, -9.451024e-04, -9.383317e-04, -9.312301e-04, -9.238174e-04, -9.160694e-04, -9.080062e-04, -8.996038e-04, -8.908817e-04, -8.818169e-04, -8.724285e-04, -8.626935e-04, -8.526316e-04, -8.422199e-04, -8.314777e-04, -8.203829e-04, -8.089542e-04, -7.971705e-04, -7.850498e-04, -7.725717e-04, -7.597541e-04, -7.465770e-04, -7.330580e-04, -7.191776e-04, -7.049533e-04, -6.903660e-04, -6.754331e-04, -6.601363e-04, -6.444922e-04, -6.284829e-04, -6.121255e-04, -5.954026e-04, -5.783303e-04, -5.608925e-04, -5.431046e-04, -5.249513e-04, -5.064478e-04, -4.875790e-04, -4.683604e-04, -4.487772e-04, -4.288446e-04, -4.085483e-04, -3.879037e-04, -3.668965e-04, -3.455422e-04, -3.238273e-04, -3.017667e-04, -2.793471e-04, -2.565840e-04, -2.334646e-04, -2.100033e-04, -1.861888e-04, -1.620349e-04, -1.375308e-04, -1.126905e-04, -8.750314e-05, -6.198300e-05, -3.611957e-05, -9.927042e-06, 1.660478e-05, 4.346168e-05, 7.065327e-05, 9.816573e-05, 1.260078e-04, 1.541661e-04, 1.826492e-04, 2.114432e-04, 2.405561e-04, 2.699750e-04, 2.997068e-04, 3.297387e-04, 3.600774e-04, 3.907099e-04, 4.216430e-04, 4.528630e-04, 4.843769e-04, 5.161708e-04, 5.482514e-04, 5.806050e-04, 6.132376e-04, 6.461357e-04, 6.793047e-04, 7.127316e-04, 7.464213e-04, 7.803607e-04, 8.145540e-04, 8.489889e-04, 8.836688e-04, 9.185812e-04, 9.537297e-04, 9.891015e-04, 1.024700e-03, 1.060512e-03, 1.096542e-03, 1.132775e-03, 1.169216e-03, 1.205850e-03, 1.242681e-03, 1.279696e-03, 1.316897e-03, 1.354271e-03, 1.391820e-03, 1.429532e-03, 1.467408e-03, 1.505435e-03, 1.543615e-03, 1.581934e-03, 1.620395e-03, 1.658984e-03, 1.697702e-03, 1.736537e-03, 1.775489e-03, 1.814546e-03, 1.853707e-03, 1.892960e-03, 1.932306e-03, 1.971732e-03, 2.011237e-03, 2.050810e-03, 2.090449e-03, 2.130143e-03, 2.169890e-03, 2.209680e-03, 2.249509e-03, 2.289367e-03, 2.329251e-03, 2.369152e-03, 2.409065e-03, 2.448981e-03, 2.488896e-03, 2.528800e-03, 2.568690e-03, 2.608555e-03, 2.648392e-03, 2.688190e-03, 2.727946e-03, 2.767650e-03, 2.807299e-03, 2.846881e-03, 2.886393e-03, 2.925825e-03, 2.965173e-03, 3.004427e-03, 3.043583e-03, 3.082631e-03, 3.121566e-03, 3.160380e-03, 3.199068e-03, 3.237619e-03, 3.276030e-03, 3.314291e-03, 3.352398e-03, 3.390341e-03, 3.428115e-03, 3.465712e-03, 3.503126e-03, 3.540348e-03, 3.577374e-03, 3.614195e-03, 3.650805e-03, 3.687196e-03, 3.723363e-03, 3.759298e-03, 3.794995e-03, 3.830446e-03, 3.865645e-03, 3.900585e-03, 3.935260e-03, 3.969663e-03, 4.003788e-03, 4.037627e-03, 4.071175e-03, 4.104425e-03, 4.137371e-03, 4.170005e-03, 4.202323e-03, 4.234317e-03, 4.265982e-03, 4.297311e-03, 4.328299e-03, 4.358938e-03, 4.389224e-03, 4.419150e-03, 4.448710e-03, 4.477899e-03, 4.506711e-03, 4.535140e-03, 4.563181e-03, 4.590828e-03, 4.618075e-03, 4.644918e-03, 4.671350e-03, 4.697367e-03, 4.722964e-03, 4.748135e-03, 4.772876e-03, 4.797181e-03, 4.821045e-03, 4.844465e-03, 4.867434e-03, 4.889949e-03, 4.912006e-03, 4.933599e-03, 4.954724e-03, 4.975377e-03, 4.995555e-03, 5.015251e-03, 5.034465e-03, 5.053189e-03, 5.071423e-03, 5.089160e-03, 5.106399e-03, 5.123135e-03, 5.139366e-03, 5.155086e-03, 5.170295e-03, 5.184988e-03, 5.199163e-03, 5.212817e-03, 5.225946e-03, 5.238548e-03, 5.250622e-03, 5.262163e-03, 5.273170e-03, 5.283641e-03, 5.293573e-03, 5.302965e-03, 5.311814e-03, 5.320119e-03, 5.327878e-03, 5.335090e-03, 5.341752e-03, 5.347864e-03, 5.353424e-03, 5.358432e-03, 5.362886e-03, 5.366785e-03, 5.370128e-03, 5.372915e-03, 5.375146e-03, 5.376819e-03, 5.377935e-03, 5.378493e-03, 5.378493e-03, 5.377935e-03, 5.376819e-03, 5.375146e-03, 5.372915e-03, 5.370128e-03, 5.366785e-03, 5.362886e-03, 5.358432e-03, 5.353424e-03, 5.347864e-03, 5.341752e-03, 5.335090e-03, 5.327878e-03, 5.320119e-03, 5.311814e-03, 5.302965e-03, 5.293573e-03, 5.283641e-03, 5.273170e-03, 5.262163e-03, 5.250622e-03, 5.238548e-03, 5.225946e-03, 5.212817e-03, 5.199163e-03, 5.184988e-03, 5.170295e-03, 5.155086e-03, 5.139366e-03, 5.123135e-03, 5.106399e-03, 5.089160e-03, 5.071423e-03, 5.053189e-03, 5.034465e-03, 5.015251e-03, 4.995555e-03, 4.975377e-03, 4.954724e-03, 4.933599e-03, 4.912006e-03, 4.889949e-03, 4.867434e-03, 4.844465e-03, 4.821045e-03, 4.797181e-03, 4.772876e-03, 4.748135e-03, 4.722964e-03, 4.697367e-03, 4.671350e-03, 4.644918e-03, 4.618075e-03, 4.590828e-03, 4.563181e-03, 4.535140e-03, 4.506711e-03, 4.477899e-03, 4.448710e-03, 4.419150e-03, 4.389224e-03, 4.358938e-03, 4.328299e-03, 4.297311e-03, 4.265982e-03, 4.234317e-03, 4.202323e-03, 4.170005e-03, 4.137371e-03, 4.104425e-03, 4.071175e-03, 4.037627e-03, 4.003788e-03, 3.969663e-03, 3.935260e-03, 3.900585e-03, 3.865645e-03, 3.830446e-03, 3.794995e-03, 3.759298e-03, 3.723363e-03, 3.687196e-03, 3.650805e-03, 3.614195e-03, 3.577374e-03, 3.540348e-03, 3.503126e-03, 3.465712e-03, 3.428115e-03, 3.390341e-03, 3.352398e-03, 3.314291e-03, 3.276030e-03, 3.237619e-03, 3.199068e-03, 3.160380e-03, 3.121566e-03, 3.082631e-03, 3.043583e-03, 3.004427e-03, 2.965173e-03, 2.925825e-03, 2.886393e-03, 2.846881e-03, 2.807299e-03, 2.767650e-03, 2.727946e-03, 2.688190e-03, 2.648392e-03, 2.608555e-03, 2.568690e-03, 2.528800e-03, 2.488896e-03, 2.448981e-03, 2.409065e-03, 2.369152e-03, 2.329251e-03, 2.289367e-03, 2.249509e-03, 2.209680e-03, 2.169890e-03, 2.130143e-03, 2.090449e-03, 2.050810e-03, 2.011237e-03, 1.971732e-03, 1.932306e-03, 1.892960e-03, 1.853707e-03, 1.814546e-03, 1.775489e-03, 1.736537e-03, 1.697702e-03, 1.658984e-03, 1.620395e-03, 1.581934e-03, 1.543615e-03, 1.505435e-03, 1.467408e-03, 1.429532e-03, 1.391820e-03, 1.354271e-03, 1.316897e-03, 1.279696e-03, 1.242681e-03, 1.205850e-03, 1.169216e-03, 1.132775e-03, 1.096542e-03, 1.060512e-03, 1.024700e-03, 9.891015e-04, 9.537297e-04, 9.185812e-04, 8.836688e-04, 8.489889e-04, 8.145540e-04, 7.803607e-04, 7.464213e-04, 7.127316e-04, 6.793047e-04, 6.461357e-04, 6.132376e-04, 5.806050e-04, 5.482514e-04, 5.161708e-04, 4.843769e-04, 4.528630e-04, 4.216430e-04, 3.907099e-04, 3.600774e-04, 3.297387e-04, 2.997068e-04, 2.699750e-04, 2.405561e-04, 2.114432e-04, 1.826492e-04, 1.541661e-04, 1.260078e-04, 9.816573e-05, 7.065327e-05, 4.346168e-05, 1.660478e-05, -9.927042e-06, -3.611957e-05, -6.198300e-05, -8.750314e-05, -1.126905e-04, -1.375308e-04, -1.620349e-04, -1.861888e-04, -2.100033e-04, -2.334646e-04, -2.565840e-04, -2.793471e-04, -3.017667e-04, -3.238273e-04, -3.455422e-04, -3.668965e-04, -3.879037e-04, -4.085483e-04, -4.288446e-04, -4.487772e-04, -4.683604e-04, -4.875790e-04, -5.064478e-04, -5.249513e-04, -5.431046e-04, -5.608925e-04, -5.783303e-04, -5.954026e-04, -6.121255e-04, -6.284829e-04, -6.444922e-04, -6.601363e-04, -6.754331e-04, -6.903660e-04, -7.049533e-04, -7.191776e-04, -7.330580e-04, -7.465770e-04, -7.597541e-04, -7.725717e-04, -7.850498e-04, -7.971705e-04, -8.089542e-04, -8.203829e-04, -8.314777e-04, -8.422199e-04, -8.526316e-04, -8.626935e-04, -8.724285e-04, -8.818169e-04, -8.908817e-04, -8.996038e-04, -9.080062e-04, -9.160694e-04, -9.238174e-04, -9.312301e-04, -9.383317e-04, -9.451024e-04, -9.515668e-04, -9.577044e-04, -9.635408e-04, -9.690550e-04, -9.742731e-04, -9.791736e-04, -9.837836e-04, -9.880807e-04, -9.920933e-04, -9.957980e-04, -9.992233e-04, -1.002347e-03, -1.005197e-03, -1.007750e-03, -1.010036e-03, -1.012031e-03, -1.013764e-03, -1.015213e-03, -1.016407e-03, -1.017321e-03, -1.017988e-03, -1.018381e-03, -1.018533e-03, -1.018418e-03, -1.018068e-03, -1.017457e-03, -1.016619e-03, -1.015527e-03, -1.014213e-03, -1.012652e-03, -1.010877e-03, -1.008862e-03, -1.006639e-03, -1.004183e-03, -1.001527e-03, -9.986434e-04, -9.955680e-04, -9.922719e-04, -9.887911e-04, -9.850966e-04, -9.812251e-04, -9.771463e-04, -9.728981e-04, -9.684499e-04, -9.638396e-04, -9.590366e-04, -9.540782e-04, -9.489347e-04, -9.436435e-04, -9.381737e-04, -9.325642e-04, -9.267830e-04, -9.208693e-04, -9.147912e-04, -9.085883e-04, -9.022276e-04, -8.957498e-04, -8.891214e-04, -8.823832e-04, -8.755012e-04, -8.685168e-04, -8.613958e-04, -8.541798e-04, -8.468342e-04, -8.394003e-04, -8.318440e-04, -8.242071e-04, -8.164538e-04, -8.086278e-04, -8.006919e-04, -7.926902e-04, -7.845854e-04, -7.764221e-04, -7.681618e-04, -7.598502e-04, -7.514484e-04, -7.430019e-04, -7.344714e-04, -7.259031e-04, -7.172574e-04, -7.085804e-04, -6.998324e-04, -6.910592e-04, -6.822212e-04, -6.733652e-04, -6.644493e-04, -6.555224e-04, -6.465416e-04, -6.375555e-04, -6.285215e-04, -6.194886e-04, -6.104128e-04, -6.013444e-04, -5.922391e-04, -5.831467e-04, -5.740222e-04, -5.649166e-04, -5.557845e-04, -5.466767e-04, -5.375475e-04, -5.284478e-04, -5.193314e-04, -5.102508e-04, -5.011570e-04, -4.921048e-04, -4.830444e-04, -4.740298e-04, -4.650118e-04, -4.560446e-04, -4.470778e-04, -4.381666e-04, -4.292605e-04, -4.204144e-04, -4.115768e-04, -4.028035e-04, -3.940431e-04, -3.853513e-04, -3.766756e-04, -3.680728e-04, -3.594892e-04, -3.509831e-04, -3.424986e-04, -3.340957e-04, -3.257183e-04, -3.174252e-04, -3.091609e-04, -3.009845e-04, -2.928391e-04, -2.847853e-04, -2.767657e-04, -2.688404e-04, -2.609513e-04, -2.531597e-04, -2.454069e-04, -2.377545e-04, -2.301426e-04, -2.226340e-04, -2.151677e-04, -2.078078e-04, -2.004913e-04, -1.932833e-04, -1.861217e-04, -1.790695e-04, -1.720658e-04, -1.651736e-04, -1.583304e-04, -1.516009e-04, -1.449225e-04, -1.383591e-04, -1.318470e-04, -1.254519e-04, -1.191093e-04, -1.128851e-04, -1.067138e-04, -1.006624e-04, -9.466430e-05, -8.878761e-05, -8.296422e-05, -7.726276e-05, -7.161653e-05, -6.609177e-05, -6.062278e-05, -5.527654e-05, -4.998476e-05, -4.481699e-05, -3.970464e-05, -3.471611e-05, -2.978195e-05, -2.497242e-05, -2.021740e-05, -1.558703e-05, -1.101034e-05, -6.558772e-06, -2.160509e-06, 2.112852e-06, 6.333625e-06, 1.043040e-05, 1.447351e-05, 1.839407e-05, 2.226182e-05, 2.600640e-05, 2.970110e-05, 3.327210e-05, 3.679304e-05, 4.019167e-05, 4.354229e-05, 4.677052e-05, 4.995157e-05, 5.301131e-05, 5.602549e-05, 5.891881e-05, 6.176753e-05, 6.449680e-05, 6.718302e-05, 6.975152e-05, 7.227669e-05, 7.468593e-05, 7.705406e-05, 7.930569e-05, 8.152050e-05, 8.361894e-05, 8.568049e-05, 8.762833e-05, 8.954196e-05, 9.134228e-05, 9.310978e-05, 9.476614e-05, 9.639170e-05, 9.790699e-05, 9.939283e-05, 1.007706e-04, 1.021210e-04, 1.033655e-04, 1.045832e-04, 1.056964e-04, 1.067864e-04, 1.077712e-04, 1.087379e-04, 1.096002e-04, 1.104437e-04, 1.111865e-04, 1.119136e-04, 1.125401e-04, 1.131525e-04, 1.136674e-04, 1.141703e-04, 1.145765e-04, 1.149722e-04, 1.152737e-04, 1.155675e-04, 1.157689e-04, 1.159637e-04, 1.160670e-04, 1.161679e-04, 1.161764e-04, 1.161878e-04, 1.161083e-04, 1.160298e-04, 1.158655e-04, 1.157050e-04, 1.154584e-04, 1.152176e-04, 1.148943e-04, 1.145789e-04, 1.141813e-04, 1.137930e-04, 1.133251e-04, 1.128696e-04, 1.123360e-04, 1.118164e-04, 1.112188e-04, 1.106397e-04, 1.099817e-04, 1.093470e-04, 1.086362e-04, 1.079444e-04, 1.071829e-04, 1.064431e-04, 1.056316e-04, 1.048442e-04, 1.039891e-04, 1.031599e-04, 1.022625e-04, 1.013920e-04, 1.004557e-04, 9.954983e-05, 9.857916e-05, 9.764021e-05, 9.663588e-05, 9.566719e-05, 9.463250e-05, 9.363693e-05, 9.258019e-05, 9.155506e-05, 9.047683e-05, 8.943364e-05, 8.833200e-05, 8.726887e-05, 8.615229e-05, 8.507572e-05, 8.394346e-05, 8.285175e-05, 8.170670e-05, 8.060583e-05, 7.945254e-05, 7.834415e-05, 7.718256e-05, 7.606856e-05, 7.490189e-05, 7.378413e-05, 7.262101e-05, 7.149533e-05, 7.033360e-05, 6.921495e-05, 6.804793e-05, 6.692963e-05, 6.576992e-05, 6.465943e-05, 6.350342e-05, 6.239623e-05, 6.124635e-05, 6.014887e-05, 5.900984e-05, 5.792269e-05, 5.679321e-05, 5.571599e-05, 5.459845e-05, 5.353189e-05, 5.243555e-05, 5.137435e-05, 5.029406e-05, 4.926175e-05, 4.818364e-05, 4.716410e-05, 4.611177e-05, 4.511536e-05, 4.407934e-05, 4.309672e-05, 4.207852e-05, 4.111710e-05, 4.012255e-05, 3.918257e-05, 3.820956e-05, 3.728851e-05, 3.633867e-05, 3.543629e-05, 3.451975e-05, 3.362849e-05, 3.273384e-05, 3.189723e-05, 3.099205e-05, 3.016544e-05, 2.930539e-05, 2.850951e-05, 2.767003e-05, 2.688835e-05, 2.607144e-05, 2.531633e-05, 2.453233e-05, 2.380551e-05, 2.305072e-05, 2.234469e-05, 2.161669e-05, 2.092707e-05, 2.023703e-05, 1.955180e-05, 1.887763e-05, 1.833830e-05, 1.757059e-05, 1.699279e-05, 1.635741e-05, 1.582262e-05, 1.520470e-05, 1.466312e-05, 1.405069e-05, 1.352222e-05, 1.293860e-05, 1.244378e-05, 1.189874e-05, 1.143953e-05, 1.092783e-05, 1.049622e-05, 1.000845e-05, 9.596512e-06, 9.126226e-06, 9.361938e-05];

const weights_hpf = [-8.838946e-03, 1.206679e-02, 3.576959e-03, -1.027588e-03, -3.022487e-03, -3.361154e-03, -2.729399e-03, -1.604783e-03, -3.167874e-04, 8.927921e-04, 1.844037e-03, 2.413584e-03, 2.527457e-03, 2.159727e-03, 1.361024e-03, 2.565049e-04, -9.758543e-04, -2.113983e-03, -2.932345e-03, -3.250006e-03, -2.950908e-03, -2.033340e-03, -6.201774e-04, 1.068799e-03, 2.715955e-03, 3.999785e-03, 4.619744e-03, 4.384278e-03, 3.248876e-03, 1.344292e-03, -1.033788e-03, -3.466303e-03, -5.477312e-03, -6.627976e-03, -6.591328e-03, -5.246786e-03, -2.711477e-03, 6.484685e-04, 4.260996e-03, 7.449866e-03, 9.543220e-03, 1.000465e-02, 8.552852e-03, 5.235267e-03, 4.672161e-04, -5.003671e-03, -1.020736e-02, -1.409607e-02, -1.574028e-02, -1.450770e-02, -1.021148e-02, -3.203844e-03, 5.610695e-03, 1.484577e-02, 2.282965e-02, 2.777195e-02, 2.815225e-02, 2.280965e-02, 1.132134e-02, -6.002474e-03, -2.804255e-02, -5.291954e-02, -7.828756e-02, -1.015939e-01, -1.203522e-01, -1.325007e-01, 8.632965e-01, -1.325007e-01, -1.203522e-01, -1.015939e-01, -7.828756e-02, -5.291954e-02, -2.804255e-02, -6.002474e-03, 1.132134e-02, 2.280965e-02, 2.815225e-02, 2.777195e-02, 2.282965e-02, 1.484577e-02, 5.610695e-03, -3.203844e-03, -1.021148e-02, -1.450770e-02, -1.574028e-02, -1.409607e-02, -1.020736e-02, -5.003671e-03, 4.672161e-04, 5.235267e-03, 8.552852e-03, 1.000465e-02, 9.543220e-03, 7.449866e-03, 4.260996e-03, 6.484685e-04, -2.711477e-03, -5.246786e-03, -6.591328e-03, -6.627976e-03, -5.477312e-03, -3.466303e-03, -1.033788e-03, 1.344292e-03, 3.248876e-03, 4.384278e-03, 4.619744e-03, 3.999785e-03, 2.715955e-03, 1.068799e-03, -6.201774e-04, -2.033340e-03, -2.950908e-03, -3.250006e-03, -2.932345e-03, -2.113983e-03, -9.758543e-04, 2.565049e-04, 1.361024e-03, 2.159727e-03, 2.527457e-03, 2.413584e-03, 1.844037e-03, 8.927921e-04, -3.167874e-04, -1.604783e-03, -2.729399e-03, -3.361154e-03, -3.022487e-03, -1.027588e-03, 3.576959e-03, 1.206679e-02, -8.838946e-03];

//======================================================
// Audio Processing:

// Create a ScriptProcessorNode
const bufferSize = 2048;
const processor = audioCtx.createScriptProcessor(bufferSize);

// Assign the onProcess function to be called for every buffer
processor.onaudioprocess = onProcess;

function onProcess(e) {
    let leftIn = e.inputBuffer.getChannelData(0);
    let rightIn = e.inputBuffer.getChannelData(1);
    let leftOut = e.outputBuffer.getChannelData(0);
    let rightOut = e.outputBuffer.getChannelData(1);


    const al = leftIn.length;
    const wl_lpf = weights_lpf.length;
    const wl_hpf = weights_hpf.length;
    const offset_lpf = ~~(wl_lpf / 2);
    const offset_hpf = ~~(wl_hpf / 2);
    // var output = new Array(al);

    // Low-pass
    let x = Array(leftIn.length);
    for (var i = 0; i < al; i++) {

        const kmin_lpf = (i >= offset_lpf) ? 0 : offset_lpf - i;
        const kmax_lpf = (i + offset_lpf < al) ? wl_lpf - 1 : al - 1 - i + offset_lpf;

        const kmin_hpf = (i >= offset_hpf) ? 0 : offset_hpf - i;
        const kmax_hpf = (i + offset_hpf < al) ? wl_hpf - 1 : al - 1 - i + offset_hpf;

        leftOut[i] = 0;
        rightOut[i] = 0;
        for (let k = kmin_lpf; k <= kmax_lpf; k++)
            leftOut[i] += leftIn[i - offset_lpf + k] * weights_lpf[k];

        for (let k = kmin_hpf; k <= kmax_hpf; k++)
            rightOut[i] += rightIn[i - offset_hpf + k] * weights_hpf[k];
    }
  
    // Plotly.plot('chart', [{
    //     y: rightIn,
    //     type:'line'
    // }]);

    // setInterval(function() {
    //     Plotly.extendTraces('chart', { y:[rightIn] }, [0]);
    // }, 2000);

    // leftOut = convolve(leftIn, h);
    // leftOut = leftIn;
    // console.log(leftOut);
    console.log('leftIn.length = ', leftIn.length);
    console.log('leftOut.length = ', leftOut.length);
}
//======================================================

// connect our graph
//track.connect(gainNode).connect(panner).connect(audioCtx.destination);
track.connect(gainNode).connect(panner).connect(processor).connect(audioCtx.destination);

const powerButton = document.querySelector('.control-power');

powerButton.addEventListener('click', function () {
    if (this.dataset.power === 'on') {
        audioCtx.suspend();
        this.dataset.power = 'off';
    } else if (this.dataset.power === 'off') {
        audioCtx.resume();
        this.dataset.power = 'on';
    }
    this.setAttribute("aria-checked", state ? "false" : "true");
    console.log(audioCtx.state);
}, false);

// Track credit: Outfoxing the Fox by Kevin MacLeod under Creative Commons 

//======================================================